<script>
  // Update form visibility based on frequency selection
  function updateFormVisibility() {
    const frequency = document.getElementById('frequency').value;
    
    // Hide all specific groups first
    document.getElementById('hourlyGroup').style.display = 'none';
    document.getElementById('weeklyGroup').style.display = 'none';
    document.getElementById('monthlyGroup').style.display = 'none';
    document.getElementById('timeGroup').style.display = 'none';
    
    // Show relevant groups based on selection
    if (frequency === 'hourly') {
      document.getElementById('hourlyGroup').style.display = 'block';
    } else {
      document.getElementById('timeGroup').style.display = 'block';
      
      if (frequency === 'weekly') {
        document.getElementById('weeklyGroup').style.display = 'block';
      } else if (frequency === 'monthly') {
        document.getElementById('monthlyGroup').style.display = 'block';
      }
    }
  }
  
  // Toggle day button selection
  function toggleDay(button) {
    button.classList.toggle('selected');
  }
  
  // Create a new trigger
  function createTrigger() {
    // Get form values
    const frequency = document.getElementById('frequency').value;
    const sheetName = document.getElementById('sheetName').value;
    
    // Validate form based on frequency
    let isValid = true;
    let triggerData = {
      sheetName: sheetName,
      frequency: frequency
    };
    
    if (frequency === 'hourly') {
      triggerData.hourlyInterval = document.getElementById('hourlyInterval').value;
    } else {
      triggerData.hour = document.getElementById('hour').value;
      triggerData.minute = document.getElementById('minute').value;
      
      if (frequency === 'weekly') {
        // Get selected days
        const selectedDays = [];
        document.querySelectorAll('.day-button.selected').forEach(function(button) {
          selectedDays.push(button.getAttribute('data-day'));
        });
        
        if (selectedDays.length === 0) {
          showStatus('error', 'Please select at least one day of the week');
          isValid = false;
        }
        
        triggerData.weekDays = selectedDays;
      } else if (frequency === 'monthly') {
        triggerData.monthDay = document.getElementById('monthDay').value;
      }
    }
    
    // If form is valid, create the trigger
    if (isValid) {
      // Show loading spinner and disable buttons
      document.getElementById('saveLoading').style.display = 'inline-flex';
      document.getElementById('saveBtn').disabled = true;
      document.getElementById('cancelBtn').disabled = true;
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            // Reset form state
            document.getElementById('saveLoading').style.display = 'none';
            document.getElementById('saveBtn').disabled = false;
            document.getElementById('cancelBtn').disabled = false;
            
            // Show success message
            showStatus('success', 'Sync schedule created successfully!');
            
            // Add the new trigger to the UI
            if (result.triggerInfo) {
              // Check if we need to replace the "no triggers" message
              const noTriggersMessage = document.querySelector('.no-triggers');
              if (noTriggersMessage) {
                // Remove the "no triggers" message
                noTriggersMessage.parentNode.removeChild(noTriggersMessage);
                
                // Create the table to hold triggers
                const container = document.querySelector('.container');
                const createHeading = document.querySelector('h4');
                
                const existingTriggersDiv = document.createElement('div');
                existingTriggersDiv.className = 'existing-triggers';
                existingTriggersDiv.innerHTML = `
                  <h4>Existing Sync Schedules</h4>
                  <table class="triggers-table">
                    <thead>
                      <tr>
                        <th>Frequency</th>
                        <th>Details</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                `;
                
                container.insertBefore(existingTriggersDiv, createHeading);
              }
              
              // Get the table body to add the new row
              const tableBody = document.querySelector('.triggers-table tbody');
              
              // Create a new row for this trigger
              const newRow = document.createElement('tr');
              newRow.id = `trigger-row-${result.triggerInfo.id}`;
              newRow.innerHTML = `
                <td>${result.triggerInfo.type}</td>
                <td>${result.triggerInfo.description}</td>
                <td>
                  <div id="remove-loading-${result.triggerInfo.id}" class="mini-loading" style="display:none;">
                    <span class="mini-loader"></span>
                  </div>
                  <button type="button" id="remove-btn-${result.triggerInfo.id}" class="delete-trigger" 
                    onclick="deleteTrigger('${result.triggerInfo.id}')">
                    Remove
                  </button>
                </td>
              `;
              
              // Add the row to the table with a fade-in effect
              newRow.classList.add('fade-in');
              tableBody.appendChild(newRow);
              
              // Reset form values
              document.getElementById('frequency').value = 'daily';
              updateFormVisibility();
            } else {
              // If we don't have trigger info, just do a full refresh
              google.script.run.showTriggerManager();
            }
          } else {
            document.getElementById('saveLoading').style.display = 'none';
            document.getElementById('saveBtn').disabled = false;
            document.getElementById('cancelBtn').disabled = false;
            showStatus('error', 'Error: ' + result.error);
          }
        })
        .withFailureHandler(function(error) {
          document.getElementById('saveLoading').style.display = 'none';
          document.getElementById('saveBtn').disabled = false;
          document.getElementById('cancelBtn').disabled = false;
          showStatus('error', 'Error: ' + error.message);
        })
        .createSyncTrigger(triggerData);
    }
  }
  
  // Delete a trigger
  function deleteTrigger(triggerId) {
    if (confirm('Are you sure you want to delete this sync schedule?')) {
      // Show loading spinner and disable button
      const loadingElement = document.getElementById('remove-loading-' + triggerId);
      const buttonElement = document.getElementById('remove-btn-' + triggerId);
      
      if (loadingElement && buttonElement) {
        loadingElement.style.display = 'inline-flex';
        buttonElement.style.display = 'none';
      }
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            // Animation for removing the row
            const row = document.getElementById('trigger-row-' + triggerId);
            if (row) {
              // Add fade-out class for animation
              row.classList.add('fade-out');
              
              // After animation completes, remove the row from DOM
              setTimeout(() => {
                // First remove the row completely from DOM
                if (row.parentNode) {
                  row.parentNode.removeChild(row);
                }
                
                // If this was the last row, show the "no triggers" message
                const remainingRows = document.querySelectorAll('.triggers-table tbody tr');
                if (remainingRows.length === 0) {
                  const table = document.querySelector('.existing-triggers');
                  if (table) {
                    table.style.display = 'none';
                    
                    // Show "no triggers" message
                    const noTriggersDiv = document.createElement('div');
                    noTriggersDiv.className = 'no-triggers';
                    noTriggersDiv.innerHTML = '<p>No automatic sync schedules are set up for this sheet.</p>';
                    table.parentNode.insertBefore(noTriggersDiv, table.nextSibling);
                  }
                }
                
                // Show success message
                showStatus('success', 'Sync schedule deleted successfully');
              }, 500);
            }
          } else {
            // Show error and reset loading state
            if (loadingElement && buttonElement) {
              loadingElement.style.display = 'none';
              buttonElement.style.display = 'inline-block';
            }
            showStatus('error', result.error || 'Error deleting trigger');
          }
        })
        .withFailureHandler(function(error) {
          // Show error and reset loading state
          if (loadingElement && buttonElement) {
            loadingElement.style.display = 'none';
            buttonElement.style.display = 'inline-block';
          }
          showStatus('error', 'Error: ' + error.message);
        })
        .deleteTrigger(triggerId);
    }
  }
  
  // Show status message
  function showStatus(type, message) {
    const indicator = document.getElementById('statusIndicator');
    indicator.className = 'indicator ' + type;
    indicator.textContent = message;
    indicator.style.display = 'block';
    
    // Auto-hide success messages after a delay
    if (type === 'success') {
      setTimeout(function() {
        indicator.style.display = 'none';
      }, 3000);
    }
  }
  
  // Initial form setup
  document.addEventListener('DOMContentLoaded', function() {
    updateFormVisibility();
  });
</script> 