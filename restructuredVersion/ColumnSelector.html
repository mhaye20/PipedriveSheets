<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
      :root {
        --primary-color: #4285f4;
        --primary-dark: #3367d6;
        --success-color: #0f9d58;
        --warning-color: #f4b400;
        --error-color: #db4437;
        --text-dark: #202124;
        --text-light: #5f6368;
        --bg-light: #f8f9fa;
        --border-color: #dadce0;
        --shadow: 0 1px 3px rgba(60,64,67,0.15);
        --shadow-hover: 0 4px 8px rgba(60,64,67,0.2);
        --transition: all 0.2s ease;
      }
      
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      
      body {
        font-family: 'Roboto', Arial, sans-serif;
        color: var(--text-dark);
        line-height: 1.5;
        margin: 0;
        padding: 16px;
        font-size: 14px;
      }
      
      .header {
        margin-bottom: 16px;
      }
      
      h3 {
        font-size: 18px;
        font-weight: 500;
        margin-bottom: 12px;
        color: var(--text-dark);
      }
      
      .sheet-info {
        background-color: var(--bg-light);
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 16px;
        font-size: 14px;
        border-left: 4px solid var(--primary-color);
        display: flex;
        align-items: center;
      }
      
      .sheet-info svg {
        margin-right: 12px;
        fill: var(--primary-color);
      }
      
      .info {
        font-size: 13px;
        color: var(--text-light);
        margin-bottom: 16px;
      }
      
      .container {
        display: flex;
        height: 400px;
        gap: 16px;
      }
      
      .column {
        width: 50%;
        display: flex;
        flex-direction: column;
      }
      
      .column-header {
        font-weight: 500;
        margin-bottom: 8px;
        padding: 0 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      
      .column-count {
        font-size: 12px;
        color: var(--text-light);
        font-weight: normal;
      }
      
      .search {
        padding: 10px 12px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        margin-bottom: 12px;
        font-size: 14px;
        width: 100%;
        transition: var(--transition);
      }
      
      .search:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(66,133,244,0.2);
      }
      
      .scrollable {
        flex-grow: 1;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background-color: white;
      }
      
      .item {
        padding: 8px 12px;
        margin: 2px 4px;
        cursor: pointer;
        border-radius: 4px;
        transition: var(--transition);
        display: flex;
        align-items: center;
      }
      
      .item:hover {
        background-color: rgba(66,133,244,0.08);
      }
      
      .item.selected {
        background-color: #e8f0fe;
        position: relative;
      }
      
      .item.selected:hover {
        background-color: #d2e3fc;
      }
      
      .category {
        font-weight: 500;
        padding: 8px 12px;
        background-color: var(--bg-light);
        margin: 8px 4px 4px 4px;
        border-radius: 4px;
        color: var(--text-dark);
        font-size: 13px;
      }
      
      .nested {
        margin-left: 16px;
        position: relative;
      }
      
      .nested::before {
        content: '';
        position: absolute;
        left: -8px;
        top: 50%;
        width: 6px;
        height: 1px;
        background-color: var(--border-color);
      }
      
      .footer {
        margin-top: 16px;
        display: flex;
        justify-content: space-between;
      }
      
      button {
        padding: 10px 16px;
        border: none;
        border-radius: 4px;
        font-weight: 500;
        cursor: pointer;
        font-size: 14px;
        transition: var(--transition);
      }
      
      button:focus {
        outline: none;
      }
      
      button:disabled {
        opacity: 0.7;
        cursor: not-allowed;
      }
      
      .primary-btn {
        background-color: var(--primary-color);
        color: white;
      }
      
      .primary-btn:hover {
        background-color: var(--primary-dark);
        box-shadow: var(--shadow-hover);
      }
      
      .secondary-btn {
        background-color: transparent;
        color: var(--primary-color);
      }
      
      .secondary-btn:hover {
        background-color: rgba(66,133,244,0.08);
      }
      
      .action-btns {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      
      .drag-handle {
        display: inline-block;
        width: 12px;
        height: 20px;
        background-image: radial-gradient(circle, var(--text-light) 1px, transparent 1px);
        background-size: 3px 3px;
        background-position: center;
        background-repeat: repeat;
        margin-right: 8px;
        cursor: grab;
        opacity: 0.5;
      }
      
      .selected:hover .drag-handle {
        opacity: 0.8;
      }
      
      .column-text {
        flex-grow: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      
      .add-btn, .remove-btn, .rename-btn {
        opacity: 0;
        margin-left: 6px;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        flex-shrink: 0;
        font-size: 14px;
        cursor: pointer;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      }
      
      .add-btn {
        color: var(--success-color);
        background-color: rgba(15,157,88,0.08);
      }
      
      .add-btn:hover {
        background-color: rgba(15,157,88,0.15);
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      .add-btn:active {
        transform: translateY(0);
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      }
      
      .remove-btn {
        color: var(--error-color);
        background-color: rgba(219,68,55,0.08);
      }
      
      .remove-btn:hover {
        background-color: rgba(219,68,55,0.15);
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      .remove-btn:active {
        transform: translateY(0);
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      }
      
      .rename-btn {
        color: var(--primary-color);
        background-color: rgba(66,133,244,0.08);
      }
      
      .rename-btn:hover {
        background-color: rgba(66,133,244,0.15);
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      .rename-btn:active {
        transform: translateY(0);
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      }
      
      .item.selected {
        position: relative;
        padding-right: 8px;
      }
      
      .selected .action-buttons {
        display: flex;
        align-items: center;
        margin-left: auto;
        opacity: 0;
        transition: opacity 0.2s ease;
      }
      
      .selected:hover .action-buttons {
        opacity: 1;
      }
      
      .selected .remove-btn,
      .selected .rename-btn {
        margin-left: 6px;
        opacity: 1;
      }
      
      .action-icon {
        font-size: 14px;
        line-height: 1;
        position: relative;
        top: 0px;
      }
      
      .item:hover .add-btn {
        opacity: 0.9;
      }
      
      /* Styles for address components */
      .address-component {
        background-color: rgba(0, 0, 0, 0.02);
        border-left: 3px solid var(--muted-color);
        position: relative;
      }
      
      .address-component::after {
        content: "";
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: 24px;
        background: linear-gradient(to right, transparent, rgba(0, 0, 0, 0.02));
        pointer-events: none;
      }
      
      .address-label {
        display: inline-block;
        font-size: 9px;
        background-color: var(--muted-color);
        color: white;
        padding: 1px 4px;
        border-radius: 3px;
        margin-right: 6px;
        vertical-align: middle;
        letter-spacing: 0.5px;
        font-weight: 600;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }
      
      /* Visual indicator for read-only fields */
      .read-only-indicator {
        display: inline-flex;
        align-items: center;
        margin-left: 6px;
        font-size: 10px;
        color: var(--muted-color);
        opacity: 0.8;
        border-radius: 3px;
        padding: 0 4px;
        background-color: rgba(0, 0, 0, 0.03);
      }
      
      .read-only-indicator i {
        font-size: 12px;
        margin-right: 3px;
      }
      
      .loading {
        display: none;
        align-items: center;
        margin-right: 8px;
      }
      
      .loader {
        display: inline-block;
        width: 18px;
        height: 18px;
        border: 2px solid rgba(66,133,244,0.2);
        border-radius: 50%;
        border-top-color: var(--primary-color);
        animation: spin 1s ease-in-out infinite;
      }
      
      .dragging {
        opacity: 0.4;
        box-shadow: var(--shadow-hover);
      }
      
      .over {
        border-top: 2px solid var(--primary-color);
      }
      
      .indicator {
        display: none;
        padding: 12px 16px;
        border-radius: 4px;
        margin-bottom: 16px;
        font-weight: 500;
      }
      
      .indicator.success {
        background-color: rgba(15,157,88,0.1);
        color: var(--success-color);
        border-left: 4px solid var(--success-color);
      }
      
      .indicator.error {
        background-color: rgba(219,68,55,0.1);
        color: var(--error-color);
        border-left: 4px solid var(--error-color);
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      
      /* Address field styling */
      .address-component {
        position: relative;
        padding-left: 4px;
        border-left: 2px solid rgba(66, 133, 244, 0.2);
      }
      
      .address-component::before {
        content: '';
        position: absolute;
        left: -4px;
        top: 50%;
        width: 4px;
        height: 1px;
        background-color: rgba(66, 133, 244, 0.5);
      }
      
      .address-label {
        font-size: 11px;
        padding: 1px 4px;
        border-radius: 3px;
        background-color: rgba(66, 133, 244, 0.1);
        color: var(--primary-color);
        margin-right: 4px;
      }
      
      /* Read-only field styling */
      .read-only {
        position: relative;
      }
      
      .read-only::after {
        content: '🔒';
        font-size: 11px;
        margin-left: 5px;
        opacity: 0.7;
      }
      
      /* Editable field styling */
      .editable::after {
        content: '✏️';
        font-size: 11px;
        margin-left: 5px;
        opacity: 0;
        transition: opacity 0.2s ease;
      }
      
      .editable:hover::after {
        opacity: 0.7;
      }
      
      /* Info tooltip */
      .info-tooltip {
        padding: 10px 14px;
        background-color: #fff8e1;
        border-radius: 8px;
        border-left: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.06);
        margin-bottom: 12px;
        font-size: 12px;
        color: #5d4901;
        display: flex;
        align-items: flex-start;
        position: relative;
        overflow: hidden;
        transition: all 0.2s ease;
      }
      
      .info-tooltip:hover {
        box-shadow: 0 3px 6px rgba(0,0,0,0.1);
      }
      
      .info-tooltip::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background-color: var(--warning-color);
      }
      
      .info-tooltip-icon {
        margin-right: 10px;
        flex-shrink: 0;
        opacity: 0.9;
        font-size: 14px;
      }
      
      .info-tooltip-content {
        margin: 0;
        flex: 1;
      }
      
      .info-tooltip-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 2px;
      }
      
      .info-tooltip-title {
        font-weight: 500;
        font-size: 13px;
        color: #33280b;
      }
      
      .info-tooltip-toggle {
        color: var(--primary-color);
        font-weight: 500;
        cursor: pointer;
        font-size: 11px;
        text-decoration: none;
        margin-left: 8px;
        white-space: nowrap;
        opacity: 0.85;
        transition: opacity 0.2s ease;
        display: flex;
        align-items: center;
      }
      
      .info-tooltip-toggle:hover {
        opacity: 1;
      }
      
      .info-tooltip-toggle::after {
        content: '▼';
        font-size: 8px;
        margin-left: 4px;
        transition: transform 0.2s ease;
      }
      
      .info-tooltip-toggle.expanded::after {
        transform: rotate(180deg);
      }
      
      .info-tooltip-description {
        font-size: 12px;
        opacity: 0.9;
      }
      
      .info-tooltip-details {
        display: none;
        margin-top: 8px;
        border-top: 1px solid rgba(95, 74, 0, 0.1);
        padding-top: 8px;
      }
      
      .info-tooltip-details.expanded {
        display: block;
        animation: fadeIn 0.3s ease;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-5px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      .info-tooltip ul {
        margin: 4px 0 0 18px;
        padding: 0;
      }
      
      .info-tooltip li {
        margin-bottom: 4px;
        font-size: 11px;
        line-height: 1.4;
      }
      
      .info-tooltip-icons {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        margin-top: 5px;
        gap: 10px;
        margin-bottom: 8px;
      }
      
      .info-icon-item {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 3px 8px;
        border-radius: 20px;
        background-color: rgba(255, 255, 255, 0.7);
        font-size: 11px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      }
      
      /* Hide address component label on smaller screens */
      @media (max-width: 600px) {
        .address-label {
          display: none;
        }
      }
      
      /* Enhanced selected columns list */
      #selectedList, #availableList {
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        background: #fcfcfc;
        margin-bottom: 8px;
        max-height: 550px;
        overflow-y: auto;
      }
      
      .list .item {
        padding: 10px 12px;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.15s ease;
      }
      
      .list .item:last-child {
        border-bottom: none;
      }
      
      .list .item:hover {
        background-color: rgba(66, 133, 244, 0.05);
      }
      
      .list .item.selected {
        background-color: rgba(66, 133, 244, 0.1);
      }
      
      .column-text {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        word-break: break-word;
        padding-right: 8px;
      }
      
      /* Style for custom named columns */
      .custom-named {
        font-style: italic;
        color: var(--primary-color);
        position: relative;
      }
      
      .column-count {
        font-size: 12px;
        background-color: #f5f5f5;
        color: #666;
        padding: 2px 8px;
        border-radius: 12px;
        margin-left: 8px;
        font-weight: normal;
      }
    </style>
    
    <?!= dataScript ?>
    <?!= include('ColumnSelectorUI') ?>
  </head>
  <body>
    <div class="header">
      <h3>Column Selection</h3>
      
      <div id="statusIndicator" class="indicator"></div>
      
      <div class="sheet-info">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
          <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14z"/>
          <path d="M7 12h10v2H7zm0-4h10v2H7zm0 8h7v2H7z"/>
        </svg>
        <div>
          Configuring columns for <strong><?= entityTypeName ?></strong> in sheet <strong>"<?= sheetName ?>"</strong>
        </div>
      </div>
      
      <p class="info">
        Select which Pipedrive data columns to display in your sheet. Drag items in the right panel to change their order.
      </p>
      
      <div class="info-tooltip">
        <div class="info-tooltip-icon">⚠️</div>
        <div class="info-tooltip-content">
          <div class="info-tooltip-header">
            <div class="info-tooltip-title">Field Editability in Pipedrive</div>
            <span class="info-tooltip-toggle" id="apiDetailsToggle" onclick="toggleApiDetails()">Details</span>
          </div>
          <div class="info-tooltip-description">Fields marked with 🔒 are read-only and cannot be pushed back to Pipedrive.</div>
          
          <div class="info-tooltip-details" id="apiDetails">
            <div class="info-tooltip-icons">
              <span class="info-icon-item">🔒 Read-only fields</span>
              <span class="info-icon-item">✏️ Editable fields</span>
            </div>
            
            Read-only fields include:
            <ul>
              <li>Address components (street, city, etc.) - only full address is editable</li>
              <li>System fields (timestamps, counts, creator info)</li>
              <li>Calculated values (formatted values, weighted values)</li>
              <li>Most ID fields except certain linkable references</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    
    <div class="container">
      <div class="column">
        <input type="text" id="searchBox" class="search" placeholder="Search for columns...">
        <div class="column-header">
          Available Columns <span id="availableCount" class="column-count"></span>
        </div>
        <div id="availableList" class="scrollable list">
          <!-- Available columns will be populated here by JavaScript -->
        </div>
      </div>
      
      <div class="column">
        <div class="column-header">
          Selected Columns <span id="selectedCount" class="column-count"></span>
        </div>
        <div id="selectedList" class="scrollable list">
          <!-- Selected columns will be populated here by JavaScript -->
        </div>
      </div>
    </div>
    
    <div class="footer">
      <div class="action-btns">
        <button class="secondary-btn" id="helpBtn">Help & Tips</button>
      </div>
      <div class="action-btns">
        <div class="loading" id="saveLoading">
          <span class="loader"></span>
        </div>
        <button class="secondary-btn" id="cancelBtn">Cancel</button>
        <button class="primary-btn" id="saveBtn">Save & Close</button>
      </div>
    </div>

    <script>
      /* 
       * Using global variables from ColumnSelectorUI.gs:
       * - availableColumns
       * - selectedColumns
       */
      
      // Define originalAvailableColumns locally if not already defined globally
      var originalAvailableColumns = typeof originalAvailableColumns !== 'undefined' ? originalAvailableColumns : [];
      
      // DOM elements
      const availableList = document.getElementById('availableList');
      const selectedList = document.getElementById('selectedList');
      const searchBox = document.getElementById('searchBox');
      const availableCountEl = document.getElementById('availableCount');
      const selectedCountEl = document.getElementById('selectedCount');
      
      // Create a deep copy of the original available columns to ensure we don't lose data
      function initializeColumns() {
        // Debug information
        console.log("Working with availableColumns:", availableColumns ? availableColumns.length : "none");
        if (!availableColumns || availableColumns.length === 0) {
          console.error("No available columns found! This is a problem.");
        } else {
          console.log("First few available columns:", availableColumns.slice(0, 5));
        }
        
        // Initialize originalAvailableColumns as a window property to ensure it's globally accessible
        window.originalAvailableColumns = availableColumns ? JSON.parse(JSON.stringify(availableColumns)) : [];
        console.log("Original available columns copy created with length:", originalAvailableColumns.length);
      }
      
      // Render the lists
      function renderAvailableList(searchTerm = '') {
        console.log("Rendering available list with search term:", searchTerm);
        console.log("Available columns before rendering:", availableColumns.length);
        console.log("Original available columns before rendering:", originalAvailableColumns.length);
        
        availableList.innerHTML = '';
        
        // Ensure search term is lowercase for case-insensitive comparison
        searchTerm = (searchTerm || '').toLowerCase();
        
        // Group columns by parent key or top-level
        const topLevel = [];
        const nested = {};
        let availableCount = 0;
        
        // Always use the original available columns array as source of truth
        originalAvailableColumns.forEach(col => {
          // Check if this column is already selected
          if (!selectedColumns.some(selected => selected.key === col.key)) {
            availableCount++;
            
            // Apply special formatting for address component names
            if (col.key && (col.key.includes('sublocality') || col.key.includes('locality'))) {
              // Make names match the display labels we want
              if (col.key.includes('sublocality')) {
                col.name = col.name.replace('District/sublocality', 'District/Borough');
                col.name = col.name.replace('Neighborhood', 'District/Borough');
              }
              if (col.key.includes('locality') && !col.key.includes('sublocality')) {
                col.name = col.name.replace('City/town/village/locality', 'City');
              }
            }
            
            if (!searchTerm || col.name.toLowerCase().includes(searchTerm)) {
              if (!col.isNested) {
                topLevel.push(col);
              } else {
                const parentKey = col.parentKey || 'unknown';
                if (!nested[parentKey]) {
                  nested[parentKey] = [];
                }
                nested[parentKey].push(col);
              }
            }
          }
        });
        
        console.log("Top level columns:", topLevel.length);
        console.log("Nested column categories:", Object.keys(nested).length);
        console.log("Total available count:", availableCount);
        
        // Update available count
        availableCountEl.textContent = '(' + availableCount + ')';
        
        // Add top-level columns first
        if (topLevel.length > 0) {
          const topLevelHeader = document.createElement('div');
          topLevelHeader.className = 'category';
          topLevelHeader.textContent = 'Main Fields';
          availableList.appendChild(topLevelHeader);
          
          topLevel.forEach(col => {
            const item = document.createElement('div');
            item.className = 'item';
            item.dataset.key = col.key;
            
            // Add read-only class for address components
            if (isReadOnlyField(col.key, col)) {
              item.classList.add('read-only');
            } else {
              item.classList.add('editable');
            }
            
            const columnText = document.createElement('span');
            columnText.className = 'column-text';
            columnText.textContent = col.name;
            item.appendChild(columnText);
            
            // Create add button
            const addBtn = document.createElement('span');
            addBtn.className = 'add-btn';
            addBtn.title = 'Add column';
            addBtn.innerHTML = '<i class="material-icons" style="font-size:18px">add</i>';
            addBtn.onclick = (e) => {
              e.stopPropagation();
              addColumn(col);
            };
            item.appendChild(addBtn);
            
            item.onclick = () => addColumn(col);
            availableList.appendChild(item);
          });
        }
        
        // Then add nested columns by parent
        for (const parentKey in nested) {
          if (nested[parentKey].length > 0) {
            // Find the parent name from the original available columns
            const parentName = originalAvailableColumns.find(col => col.key === parentKey)?.name || parentKey;
            
            const categoryHeader = document.createElement('div');
            categoryHeader.className = 'category';
            categoryHeader.textContent = parentName;
            availableList.appendChild(categoryHeader);
            
            nested[parentKey].forEach(col => {
              const item = document.createElement('div');
              item.className = 'item nested';
              item.dataset.key = col.key;
              
              // Add read-only class for address components
              if (isReadOnlyField(col.key, col)) {
                item.classList.add('read-only');
              } else {
                item.classList.add('editable');
              }
              
              const columnText = document.createElement('span');
              columnText.className = 'column-text';
              columnText.textContent = col.name;
              item.appendChild(columnText);
              
              // Create add button
              const addBtn = document.createElement('span');
              addBtn.className = 'add-btn';
              addBtn.title = 'Add column';
              addBtn.innerHTML = '<i class="material-icons" style="font-size:18px">add</i>';
              addBtn.onclick = (e) => {
                e.stopPropagation();
                addColumn(col);
              };
              item.appendChild(addBtn);
              
              item.onclick = () => addColumn(col);
              availableList.appendChild(item);
            });
          }
        }
        
        // Show "no results" message if nothing matches search
        if (availableList.children.length === 0 && searchTerm) {
          const noResults = document.createElement('div');
          noResults.style.padding = '16px';
          noResults.style.textAlign = 'center';
          noResults.style.color = 'var(--text-light)';
          noResults.textContent = 'No matching columns found';
          availableList.appendChild(noResults);
        }
      }
      
      function renderSelectedList() {
        selectedList.innerHTML = '';
        
        // Update selected count
        selectedCountEl.textContent = '(' + selectedColumns.length + ')';
        
        if (selectedColumns.length === 0) {
          const emptyState = document.createElement('div');
          emptyState.style.padding = '16px';
          emptyState.style.textAlign = 'center';
          emptyState.style.color = 'var(--text-light)';
          emptyState.innerHTML = 'No columns selected yet<br>Select columns from the left panel';
          selectedList.appendChild(emptyState);
          return;
        }
        
        selectedColumns.forEach((col, index) => {
          // Apply special formatting for address component names
          if (col.key && (col.key.includes('sublocality') || col.key.includes('locality'))) {
            // Make names match the display labels we want
            if (col.key.includes('sublocality')) {
              col.name = col.name.replace('District/sublocality', 'District/Borough');
              col.name = col.name.replace('Neighborhood', 'District/Borough');
              if (col.customName && col.customName.includes('District/sublocality')) {
                col.customName = col.customName.replace('District/sublocality', 'District/Borough');
              }
            }
            if (col.key.includes('locality') && !col.key.includes('sublocality')) {
              col.name = col.name.replace('City/town/village/locality', 'City');
              if (col.customName && col.customName.includes('City/town/village/locality')) {
                col.customName = col.customName.replace('City/town/village/locality', 'City');
              }
            }
          }
          
          const item = document.createElement('div');
          item.className = 'item selected';
          item.dataset.key = col.key;
          item.dataset.index = index;
          item.draggable = true;
          
          // Add read-only class for address components
          if (isReadOnlyField(col.key, col)) {
            item.classList.add('read-only');
          } else {
            item.classList.add('editable');
          }
          
          // Add drag handle
          const dragHandle = document.createElement('span');
          dragHandle.className = 'drag-handle';
          item.appendChild(dragHandle);
          
          // Add column name
          const columnText = document.createElement('span');
          columnText.className = 'column-text';
          
          // Special handling for address components
          if (col.key && (col.key.includes('address.') || col.key.includes('.subpremise'))) {
            // Add special styling for address components
            item.classList.add('address-component');
            
            // Extract the component type for display
            let addressType = '';
            if (col.key.includes('subpremise')) {
              addressType = 'SUITE';
            } else if (col.key.includes('street_number')) {
              addressType = 'STREET#';
            } else if (col.key.includes('route')) {
              addressType = 'STREET';
            } else if (col.key.includes('sublocality')) {
              addressType = 'DISTRICT/BOROUGH';
            } else if (col.key.includes('locality')) {
              addressType = 'CITY';
            } else if (col.key.includes('admin_area_level_1')) {
              addressType = 'STATE';
            } else if (col.key.includes('postal_code')) {
              addressType = 'ZIP';
            } else if (col.key.includes('country')) {
              addressType = 'COUNTRY';
            }
            
            // Only add the type label if we have a recognized type
            if (addressType) {
              const addressLabel = document.createElement('span');
              addressLabel.className = 'address-label';
              addressLabel.textContent = addressType;
              columnText.appendChild(addressLabel);
              
              // Add read-only indicator for address components
              const readOnlyIndicator = document.createElement('span');
              readOnlyIndicator.className = 'read-only-indicator';
              readOnlyIndicator.innerHTML = '<i class="material-icons" style="font-size:14px">lock</i> Read-only';
              readOnlyIndicator.title = 'Address components from Pipedrive are read-only';
              columnText.appendChild(readOnlyIndicator);
            }
          }
          
          columnText.appendChild(document.createTextNode(col.customName || col.name));
          if (col.customName) {
            columnText.title = "Original field: " + col.name;
            columnText.style.fontStyle = 'italic';
            columnText.classList.add('custom-named');
          }
          item.appendChild(columnText);
          
          // Create container for action buttons
          const actionButtons = document.createElement('div');
          actionButtons.className = 'action-buttons';
          
          // Add rename button
          const renameBtn = document.createElement('span');
          renameBtn.className = 'rename-btn';
          renameBtn.innerHTML = '<i class="material-icons" style="font-size:18px">edit</i>';
          renameBtn.title = 'Rename column';
          renameBtn.onclick = (e) => {
            e.stopPropagation();
            renameColumn(index);
          };
          actionButtons.appendChild(renameBtn);
          
          // Add remove button
          const removeBtn = document.createElement('span');
          removeBtn.className = 'remove-btn';
          removeBtn.innerHTML = '<i class="material-icons" style="font-size:18px">close</i>';
          removeBtn.title = 'Remove column';
          removeBtn.onclick = (e) => {
            e.stopPropagation();
            removeColumn(col);
          };
          actionButtons.appendChild(removeBtn);
          
          // Add the action buttons container to the item
          item.appendChild(actionButtons);
          
          // Set up drag events
          item.ondragstart = handleDragStart;
          item.ondragover = handleDragOver;
          item.ondrop = handleDrop;
          item.ondragend = handleDragEnd;
          
          selectedList.appendChild(item);
        });
      }
      
      // Drag and drop functionality
      let draggedItem = null;
      
      function handleDragStart(e) {
        draggedItem = this;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', this.dataset.index);
        
        // Add a small delay to make the visual change noticeable
        setTimeout(() => {
          this.style.opacity = '0.4';
        }, 0);
      }
      
      function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        this.classList.add('over');
      }
      
      function handleDrop(e) {
        e.preventDefault();
        this.classList.remove('over');
        
        const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
        const toIndex = parseInt(this.dataset.index);
        
        if (fromIndex !== toIndex) {
          const item = selectedColumns[fromIndex];
          selectedColumns.splice(fromIndex, 1);
          selectedColumns.splice(toIndex, 0, item);
          renderSelectedList();
        }
      }
      
      function handleDragEnd() {
        this.classList.remove('dragging');
        document.querySelectorAll('.item').forEach(item => {
          item.classList.remove('over');
        });
      }
      
      // Column management
      function addColumn(column) {
        // Find the column in the original available columns array to ensure we have complete data
        const fullColumn = originalAvailableColumns.find(col => col.key === column.key);
        if (fullColumn) {
          // Add a deep copy to prevent reference issues
          selectedColumns.push(JSON.parse(JSON.stringify(fullColumn)));
          renderAvailableList(searchBox.value);
          renderSelectedList();
        }
      }
      
      function removeColumn(column) {
        const index = selectedColumns.findIndex(col => col.key === column.key);
        if (index !== -1) {
          selectedColumns.splice(index, 1);
          renderAvailableList(searchBox.value);
          renderSelectedList();
        }
      }
      
      function renameColumn(columnIndex) {
        const column = selectedColumns[columnIndex];
        const currentName = column.customName || column.name;
        const newName = prompt("Enter custom header name for '" + column.name + "'", currentName);
        
        if (newName !== null) {
          // Update the column with the custom name
          selectedColumns[columnIndex].customName = newName;
          renderSelectedList();
          showStatus('success', 'Column renamed to: ' + newName);
        }
      }
      
      function showStatus(type, message) {
        const indicator = document.getElementById('statusIndicator');
        indicator.className = 'indicator ' + type;
        indicator.textContent = message;
        indicator.style.display = 'block';
        
        // Auto-hide after a delay
        setTimeout(function() {
          indicator.style.display = 'none';
        }, 2000);
      }
      
      // Event listeners
      document.getElementById('saveBtn').onclick = () => {
        if (selectedColumns.length === 0) {
          showStatus('error', 'Please select at least one column');
          return;
        }
        
        console.log('Save button clicked, sending data to server');
        console.log(`Sending ${selectedColumns.length} columns to save`);
        
        // Update any address component display names before saving
        selectedColumns.forEach(col => {
          if (col.key && (col.key.includes('sublocality') || col.key.includes('locality'))) {
            // Make sure names match display labels
            if (col.key.includes('sublocality')) {
              col.name = col.name.replace('District/sublocality', 'District/Borough');
              col.name = col.name.replace('Neighborhood', 'District/Borough');
              if (col.customName && col.customName.includes('District/sublocality')) {
                col.customName = col.customName.replace('District/sublocality', 'District/Borough');
              }
            }
            if (col.key.includes('locality') && !col.key.includes('sublocality')) {
              col.name = col.name.replace('City/town/village/locality', 'City');
              if (col.customName && col.customName.includes('City/town/village/locality')) {
                col.customName = col.customName.replace('City/town/village/locality', 'City');
              }
            }
          }
        });
        
        // Log email and phone columns specifically
        const emailColumns = selectedColumns.filter(col => col.key.startsWith('email.'));
        const phoneColumns = selectedColumns.filter(col => col.key.startsWith('phone.'));
        
        console.log('Email columns:', emailColumns);
        console.log('Phone columns:', phoneColumns);
        
        // Show loading animation
        document.getElementById('saveLoading').style.display = 'flex';
        document.getElementById('saveBtn').disabled = true;
        document.getElementById('cancelBtn').disabled = true;
        
        console.log('Calling handleSaveColumns with:', {
          columns: selectedColumns.map(c => ({key: c.key, name: c.name, customName: c.customName})),
          entityType,
          sheetName
        });
        
        google.script.run
          .withSuccessHandler((result) => {
            console.log('Save successful, result:', result);
            document.getElementById('saveLoading').style.display = 'none';
            showStatus('success', 'Column preferences saved successfully!');
            
            // Close after a short delay to show the success message
            setTimeout(() => {
              google.script.host.close();
            }, 1500);
          })
          .withFailureHandler((error) => {
            console.error('Save failed:', error);
            document.getElementById('saveLoading').style.display = 'none';
            document.getElementById('saveBtn').disabled = false;
            document.getElementById('cancelBtn').disabled = false;
            showStatus('error', 'Error: ' + error.message);
          })
          .handleSaveColumns(selectedColumns, entityType, sheetName);
      };
      
      document.getElementById('cancelBtn').onclick = () => {
        google.script.host.close();
      };
      
      document.getElementById('helpBtn').onclick = () => {
        const helpContent = 'Tips for selecting columns:\n' +
                           '\n• Search for specific columns using the search box' +
                           '\n• Main fields are top-level Pipedrive fields' +
                           '\n• Nested fields provide more detailed information' +
                           '\n• Drag and drop to reorder selected columns' +
                           '\n• The column order here determines the order in your sheet';
                           
        alert(helpContent);
      };
      
      searchBox.oninput = () => {
        renderAvailableList(searchBox.value);
      };
      
      // Initial render
      renderAvailableList();
      renderSelectedList();
      
      // Toggle API details
      function toggleApiDetails() {
        const details = document.getElementById('apiDetails');
        const toggle = document.getElementById('apiDetailsToggle');
        
        if (details.classList.contains('expanded')) {
          details.classList.remove('expanded');
          toggle.classList.remove('expanded');
          toggle.textContent = 'Details';
        } else {
          details.classList.add('expanded');
          toggle.classList.add('expanded');
          toggle.textContent = 'Hide';
        }
      }

      // Add this helper function to check if a field is read-only
      function isReadOnlyField(key, column) {
        // Check if the column object has a readOnly property
        if (column && column.readOnly === true) {
          return true;
        }
        
        // Check for address components - they are read-only according to Pipedrive API
        if (key && 
            (key.includes('.street_number') || 
             key.includes('.route') || 
             key.includes('.subpremise') || 
             key.includes('.sublocality') || 
             key.includes('.locality') || 
             key.includes('.admin_area_level_1') || 
             key.includes('.admin_area_level_2') || 
             key.includes('.country') || 
             key.includes('.postal_code') ||
             key.includes('_street_number') || 
             key.includes('_route') || 
             key.includes('_subpremise') || 
             key.includes('_sublocality') || 
             key.includes('_locality') || 
             key.includes('_admin_area_level_1') || 
             key.includes('_admin_area_level_2') || 
             key.includes('_country') || 
             key.includes('_postal_code'))) {
          return true;
        }
        
        // Common read-only fields across all entity types
        if (key && (
            // ID fields (except the main ID used for identification)
            (key !== 'id' && key.endsWith('_id') && key !== 'owner_id' && 
             key !== 'person_id' && key !== 'org_id' && key !== 'organization_id' && 
             key !== 'deal_id' && key !== 'lead_id' && key !== 'stage_id' && 
             key !== 'pipeline_id' && key !== 'project_id' && key !== 'category') ||
            
            // System-generated fields
            key === 'creator_user_id' || 
            key === 'user_id' || 
            key === 'followers_count' ||
            key === 'participants_count' ||
            key === 'activities_count' ||
            key === 'done_activities_count' ||
            key === 'undone_activities_count' ||
            key === 'files_count' ||
            key === 'notes_count' ||
            key === 'email_messages_count' ||
            key === 'people_count' ||
            key === 'products_count' ||
            
            // Formatted or calculated fields
            key === 'formatted_value' || 
            key === 'weighted_value' || 
            key === 'formatted_weighted_value' ||
            key === 'weighted_value_currency' ||
            key.startsWith('formatted_') ||
            
            // System fields
            key === 'first_char' ||
            key === 'active_flag' ||
            key === 'cc_email' ||
            key === 'next_activity_id' ||
            key === 'last_activity_id' ||
            key === 'last_incoming_mail_time' ||
            key === 'last_outgoing_mail_time' ||
            key === 'rotten_time' ||
            key === 'next_activity_date' ||
            key === 'next_activity_time' ||
            key === 'next_activity_type' ||
            key === 'next_activity_duration' ||
            key === 'next_activity_note' ||
            key === 'archive_time' ||
            key === 'local_close_date' ||
            key === 'local_won_date' ||
            key === 'local_lost_date' ||
            
            // Label information (can only be modified via label_ids)
            key === 'label' ||
            
            // Deal-specific read-only fields
            key === 'stage_order_nr' ||
            key === 'person_name' ||
            key === 'org_name' ||
            key === 'origin' ||
            key === 'origin_id' ||
            key === 'channel' ||
            
            // Person/Org specific
            key === 'has_pic' ||
            key === 'pic_hash' ||
            key === 'owner_name' ||
            key === 'org_hidden' ||
            key === 'person_hidden'
        )) {
          return true;
        }
        
        return false;
      }

      function renderLists() {
        renderSelectedList();
        renderAvailableList();
        
        // Update column counts
        selectedCountEl.textContent = selectedColumns.length;
        availableCountEl.textContent = availableColumns.length;
      }

      // Initialize the application
      function initApp() {
        try {
          console.log("Initializing column selector app...");
          
          // Make sure we have availableColumns
          if (typeof availableColumns === 'undefined') {
            console.warn("availableColumns is not defined, creating empty array");
            window.availableColumns = [];
          }
          
          // Make sure we have selectedColumns
          if (typeof selectedColumns === 'undefined') {
            console.warn("selectedColumns is not defined, creating empty array");
            window.selectedColumns = [];
          }
          
          // Load data from server
          loadData();
          
          // Initialize the original columns array
          initializeColumns();
          
          // Render the UI
          renderLists();
          
          console.log("App initialized successfully.");
        } catch (error) {
          console.error("Error initializing app:", error);
        }
      }
      
      window.onload = function() {
        // Initialize application first
        initApp();
        
        // Set up event listeners
        searchBox.addEventListener('input', function() {
          filterAvailableList(this.value.toLowerCase());
        });
        
        document.getElementById('saveBtn').addEventListener('click', function() {
          saveColumns();
        });
        
        document.getElementById('cancelBtn').addEventListener('click', function() {
          google.script.host.close();
        });
        
        document.getElementById('helpBtn').addEventListener('click', function() {
          showHelp();
        });
        
        document.getElementById('apiDetailsToggle').addEventListener('click', function() {
          toggleApiDetails();
        });
      };
      
      function toggleApiDetails() {
        const detailsElement = document.getElementById('apiDetails');
        const toggleButton = document.getElementById('apiDetailsToggle');
        
        if (detailsElement.style.display === 'none' || !detailsElement.style.display) {
          detailsElement.style.display = 'block';
          toggleButton.textContent = 'Hide';
        } else {
          detailsElement.style.display = 'none';
          toggleButton.textContent = 'Details';
        }
      }
      
      function loadData() {
        try {
          console.log("Attempting to load data from server...");
          // Get the data passed from the server
          const availableColumnsJson = '<?!= JSON.stringify(availableColumns) ?>';
          const selectedColumnsJson = '<?!= JSON.stringify(selectedColumns) ?>';
          
          if (!availableColumnsJson || availableColumnsJson === '<?!= JSON.stringify(availableColumns) ?>') {
            console.error('Server variables not properly processed. Using empty arrays as fallback.');
            window.availableColumns = [];
            window.selectedColumns = [];
            return;
          }
          
          // Parse the JSON data
          try {
            window.availableColumns = JSON.parse(availableColumnsJson);
            window.selectedColumns = JSON.parse(selectedColumnsJson);
            console.log('Data loaded successfully:', 
              availableColumns.length + ' available columns, ' + 
              selectedColumns.length + ' selected columns');
          } catch (parseError) {
            console.error('Error parsing data from server:', parseError);
            console.log('Raw availableColumnsJson:', availableColumnsJson.substring(0, 100) + '...');
            window.availableColumns = [];
            window.selectedColumns = [];
          }
        } catch (error) {
          console.error('Error in loadData function:', error);
          // Initialize with empty arrays to prevent further errors
          window.availableColumns = [];
          window.selectedColumns = [];
        }
      }
      
      function filterAvailableList(query) {
        const filteredColumns = availableColumns.filter(col => {
          const name = col.name ? col.name.toLowerCase() : '';
          const key = col.key ? col.key.toLowerCase() : '';
          return name.includes(query) || key.includes(query);
        });
        
        renderAvailableList(filteredColumns);
      }
      
      function renderLists() {
        renderSelectedList();
        renderAvailableList();
        
        // Update column counts
        selectedCountEl.textContent = selectedColumns.length;
        availableCountEl.textContent = availableColumns.length;
      }
    </script>
  </body>
</html> 
