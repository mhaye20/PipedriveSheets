<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
      }
      h3 {
        margin-top: 0;
        margin-bottom: 15px;
      }
      .container {
        max-width: 600px;
        margin: 0 auto;
      }
      .card {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 15px;
        margin-bottom: 20px;
        background-color: #f9f9f9;
      }
      .section {
        margin-bottom: 20px;
      }
      .section-title {
        font-weight: bold;
        margin-bottom: 10px;
      }
      input[type="text"] {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 10px;
        box-sizing: border-box;
      }
      button {
        background-color: #4285F4;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 10px;
      }
      button:hover {
        background-color: #3367D6;
      }
      button.secondary {
        background-color: #f1f1f1;
        color: #333;
      }
      button.secondary:hover {
        background-color: #e4e4e4;
      }
      button.danger {
        background-color: #EA4335;
      }
      button.danger:hover {
        background-color: #D62516;
      }
      .footer {
        margin-top: 20px;
        display: flex;
        justify-content: flex-end;
      }
      .team-info {
        margin-bottom: 10px;
      }
      .team-actions {
        margin-top: 15px;
      }
      .member-list {
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-top: 10px;
        max-height: 200px;
        overflow-y: auto;
      }
      .member-item {
        padding: 8px 15px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .member-item:last-child {
        border-bottom: none;
      }
      .member-email {
        flex-grow: 1;
      }
      .member-role {
        margin: 0 10px;
        font-size: 12px;
        color: #666;
        background-color: #f1f1f1;
        padding: 2px 8px;
        border-radius: 10px;
      }
      .hidden {
        display: none;
      }
      .tabs {
        display: flex;
        margin-bottom: 20px;
        border-bottom: 1px solid #ddd;
      }
      .tab {
        padding: 10px 15px;
        cursor: pointer;
        position: relative;
      }
      .tab.active {
        color: #4285F4;
        font-weight: bold;
      }
      .tab.active:after {
        content: '';
        position: absolute;
        bottom: -1px;
        left: 0;
        right: 0;
        height: 2px;
        background-color: #4285F4;
      }
      .status-message {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }
      .status-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .status-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .status-info {
        background-color: #e1f5fe;
        color: #0277bd;
        border: 1px solid #b3e5fc;
      }
      .loading {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .spinner {
        border: 4px solid #f3f3f3;
        border-radius: 50%;
        border-top: 4px solid #4285F4;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h3>Team Management</h3>
      
      <div class="tabs">
        <div class="tab <?= initialTab === 'join' ? 'active' : '' ?>" data-tab="join">Join Team</div>
        <div class="tab <?= initialTab === 'create' ? 'active' : '' ?>" data-tab="create">Create Team</div>
        <div class="tab <?= initialTab === 'manage' ? 'active' : '' ?> <?= hasTeam ? '' : 'hidden' ?>" data-tab="manage">Manage Team</div>
      </div>
      
      <div id="status-container"></div>
      
      <!-- Join Team Section -->
      <div id="join-team-section" class="section <?= initialTab === 'join' ? '' : 'hidden' ?>">
        <div class="card">
          <div class="section-title">Join an Existing Team</div>
          <p>Enter the team ID provided by your team administrator:</p>
          <input type="text" id="team-id-input" placeholder="Team ID">
          <div id="join-team-status"></div>
          <div class="footer">
            <button id="join-team-button">Join Team</button>
          </div>
        </div>
      </div>
      
      <!-- Create Team Section -->
      <div id="create-team-section" class="section <?= initialTab === 'create' ? '' : 'hidden' ?>">
        <div class="card">
          <div class="section-title">Create a New Team</div>
          <p>Create a new team to share Pipedrive configuration with your colleagues:</p>
          <input type="text" id="team-name-input" placeholder="Team Name">
          <div id="create-team-status"></div>
          <div class="footer">
            <button id="create-team-button">Create Team</button>
          </div>
        </div>
      </div>
      
      <!-- Manage Team Section -->
      <div id="manage-team-section" class="section <?= initialTab === 'manage' ? '' : 'hidden' ?> <?= hasTeam ? '' : 'hidden' ?>">
        <div class="card">
          <div class="section-title">Current Team</div>
          <div class="team-info">
            <div><strong>Team Name:</strong> <?= teamName || 'Not in a team' ?></div>
            <div><strong>Team ID:</strong> <span id="team-id-display"><?= teamId || 'N/A' ?></span></div>
            <div><strong>Your Role:</strong> <span id="user-role"><?= userRole || 'N/A' ?></span></div>
          </div>
          
          <div class="section-title">Team Members</div>
          <div class="member-list" id="members-container">
            <? if (teamMembers && teamMembers.length > 0) { ?>
              <? teamMembers.forEach(function(member) { ?>
                <div class="member-item">
                  <div class="member-email"><?= member.email ?></div>
                  <div class="member-role"><?= member.role ?></div>
                  <? if (userRole === 'Admin' && member.email !== userEmail) { ?>
                    <button class="remove-member secondary" data-email="<?= member.email ?>">Remove</button>
                  <? } ?>
                </div>
              <? }); ?>
            <? } else { ?>
              <div class="member-item">No team members found.</div>
            <? } ?>
          </div>
          
          <? if (userRole === 'Admin') { ?>
            <div class="section-title" style="margin-top: 15px;">Add Team Member</div>
            <input type="text" id="new-member-email" placeholder="Email Address">
            <div class="footer">
              <button id="add-member-button">Add Member</button>
            </div>
          <? } ?>
          
          <div class="team-actions">
            <button id="copy-team-id" class="secondary">Copy Team ID</button>
            <button id="leave-team-button" class="danger">Leave Team</button>
            <? if (userRole === 'Admin') { ?>
              <button id="delete-team-button" class="danger">Delete Team</button>
            <? } ?>
          </div>
        </div>
      </div>
      
      <div class="footer">
        <button id="close-button" class="secondary">Close</button>
      </div>
    </div>
    
    <div id="loading-indicator" class="loading hidden">
      <div class="spinner"></div>
    </div>
    
    <script>
      // Immediately hide loading indicator
      (function() {
        document.getElementById('loading-indicator').classList.add('hidden');
      })();
      
      // Also ensure loading indicator is hidden when content is fully loaded
      document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('loading-indicator').classList.add('hidden');
      });
      
      // Tab switching
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
          // Update active tab
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          
          // Show corresponding section
          const tabId = this.dataset.tab;
          document.querySelectorAll('.section').forEach(section => {
            section.classList.add('hidden');
          });
          document.getElementById(`${tabId}-team-section`).classList.remove('hidden');
        });
      });
      
      // Helper function to show status messages
      function showStatus(message, type, containerId = 'status-container') {
        const container = document.getElementById(containerId);
        const statusDiv = document.createElement('div');
        statusDiv.className = `status-message status-${type}`;
        statusDiv.textContent = message;
        container.innerHTML = '';
        container.appendChild(statusDiv);
        
        // Auto-dismiss after 5 seconds for success messages
        if (type === 'success') {
          setTimeout(() => {
            statusDiv.remove();
          }, 5000);
        }
      }
      
      // Show loading indicator
      function showLoading() {
        document.getElementById('loading-indicator').classList.remove('hidden');
      }
      
      // Hide loading indicator
      function hideLoading() {
        document.getElementById('loading-indicator').classList.add('hidden');
      }
      
      // Join team
      document.getElementById('join-team-button').addEventListener('click', function() {
        const teamId = document.getElementById('team-id-input').value.trim();
        if (!teamId) {
          showStatus('Please enter a team ID', 'error', 'join-team-status');
          return;
        }
        
        showLoading();
        google.script.run
          .withSuccessHandler(function(result) {
            hideLoading();
            if (result.success) {
              showStatus('Successfully joined the team!', 'success');
              // Wait a bit then reload the page to reflect changes
              setTimeout(() => {
                google.script.run.showTeamManager();
                google.script.host.close();
              }, 2000);
            } else {
              showStatus(result.message || 'Error joining team', 'error', 'join-team-status');
            }
          })
          .withFailureHandler(function(error) {
            hideLoading();
            showStatus('Error: ' + error.message, 'error', 'join-team-status');
          })
          .joinTeam(teamId);
      });
      
      // Create team
      document.getElementById('create-team-button').addEventListener('click', function() {
        const teamName = document.getElementById('team-name-input').value.trim();
        if (!teamName) {
          showStatus('Please enter a team name', 'error', 'create-team-status');
          return;
        }
        
        showLoading();
        google.script.run
          .withSuccessHandler(function(result) {
            hideLoading();
            if (result.success) {
              showStatus('Team created successfully!', 'success');
              // Wait a bit then reload the page to reflect changes
              setTimeout(() => {
                google.script.run.showTeamManager();
                google.script.host.close();
              }, 2000);
            } else {
              showStatus(result.message || 'Error creating team', 'error', 'create-team-status');
            }
          })
          .withFailureHandler(function(error) {
            hideLoading();
            showStatus('Error: ' + error.message, 'error', 'create-team-status');
          })
          .createTeam(teamName);
      });
      
      // Copy team ID
      if (document.getElementById('copy-team-id')) {
        document.getElementById('copy-team-id').addEventListener('click', function() {
          const teamId = document.getElementById('team-id-display').textContent;
          
          // Create a temporary input element
          const tempInput = document.createElement('input');
          tempInput.value = teamId;
          document.body.appendChild(tempInput);
          tempInput.select();
          document.execCommand('copy');
          document.body.removeChild(tempInput);
          
          showStatus('Team ID copied to clipboard!', 'success');
        });
      }
      
      // Leave team
      if (document.getElementById('leave-team-button')) {
        document.getElementById('leave-team-button').addEventListener('click', function() {
          if (!confirm('Are you sure you want to leave this team? You will lose access to shared configurations.')) {
            return;
          }
          
          showLoading();
          google.script.run
            .withSuccessHandler(function(result) {
              hideLoading();
              if (result.success) {
                showStatus('You have left the team.', 'success');
                // Wait a bit then reload the page to reflect changes
                setTimeout(() => {
                  google.script.run.showTeamManager();
                  google.script.host.close();
                }, 2000);
              } else {
                showStatus(result.message || 'Error leaving team', 'error');
              }
            })
            .withFailureHandler(function(error) {
              hideLoading();
              showStatus('Error: ' + error.message, 'error');
            })
            .leaveTeam();
        });
      }
      
      // Delete team (admin only)
      if (document.getElementById('delete-team-button')) {
        document.getElementById('delete-team-button').addEventListener('click', function() {
          if (!confirm('Are you sure you want to delete this team? This will remove access for all team members and cannot be undone.')) {
            return;
          }
          
          showLoading();
          google.script.run
            .withSuccessHandler(function(result) {
              hideLoading();
              if (result.success) {
                showStatus('Team has been deleted.', 'success');
                // Wait a bit then reload the page to reflect changes
                setTimeout(() => {
                  google.script.run.showTeamManager();
                  google.script.host.close();
                }, 2000);
              } else {
                showStatus(result.message || 'Error deleting team', 'error');
              }
            })
            .withFailureHandler(function(error) {
              hideLoading();
              showStatus('Error: ' + error.message, 'error');
            })
            .deleteTeam();
        });
      }
      
      // Add member (admin only)
      if (document.getElementById('add-member-button')) {
        document.getElementById('add-member-button').addEventListener('click', function() {
          const email = document.getElementById('new-member-email').value.trim();
          if (!email) {
            showStatus('Please enter an email address', 'error');
            return;
          }
          
          showLoading();
          google.script.run
            .withSuccessHandler(function(result) {
              hideLoading();
              if (result.success) {
                showStatus('Member added successfully.', 'success');
                document.getElementById('new-member-email').value = '';
                
                // Add the member to the UI list
                const membersContainer = document.getElementById('members-container');
                const newMemberDiv = document.createElement('div');
                newMemberDiv.className = 'member-item';
                newMemberDiv.innerHTML = `
                  <div class="member-email">${email}</div>
                  <div class="member-role">Member</div>
                  <button class="remove-member secondary" data-email="${email}">Remove</button>
                `;
                membersContainer.appendChild(newMemberDiv);
                
                // Add event listener for the remove button
                const removeButton = newMemberDiv.querySelector('.remove-member');
                if (removeButton) {
                  removeButton.addEventListener('click', handleRemoveMember);
                }
              } else {
                showStatus(result.message || 'Error adding member', 'error');
              }
            })
            .withFailureHandler(function(error) {
              hideLoading();
              showStatus('Error: ' + error.message, 'error');
            })
            .addTeamMember(email);
        });
      }
      
      // Remove member event handler
      function handleRemoveMember() {
        const email = this.dataset.email;
        if (!confirm(`Are you sure you want to remove ${email} from the team?`)) {
          return;
        }
        
        showLoading();
        const memberItem = this.closest('.member-item');
        
        google.script.run
          .withSuccessHandler(function(result) {
            hideLoading();
            if (result.success) {
              showStatus('Member removed successfully.', 'success');
              // Remove the item from the UI
              if (memberItem) {
                memberItem.remove();
              }
            } else {
              showStatus(result.message || 'Error removing member', 'error');
            }
          })
          .withFailureHandler(function(error) {
            hideLoading();
            showStatus('Error: ' + error.message, 'error');
          })
          .removeTeamMember(email);
      }
      
      // Attach event listeners to remove member buttons
      document.querySelectorAll('.remove-member').forEach(button => {
        button.addEventListener('click', handleRemoveMember);
      });
      
      // Close button
      document.getElementById('close-button').addEventListener('click', function() {
        google.script.host.close();
      });
    </script>
  </body>
</html> 